CREATE TABLE CLIENTE (
    id_cliente SERIAL PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    telefone VARCHAR(20),
    email VARCHAR(100) UNIQUE,
    endereco_completo VARCHAR(255),
    cep VARCHAR(10)
);

CREATE TABLE FUNCIONARIO (
    id_funcionario SERIAL PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    telefone VARCHAR(20),
    email VARCHAR(100) UNIQUE,
    data_nascimento DATE NOT NULL,
    endereco_completo VARCHAR(255),
    cep VARCHAR(10),
    cargo VARCHAR(50) NOT NULL
);

CREATE TABLE MOTORISTA (
    id_motorista INTEGER PRIMARY KEY,
    cnh_numero VARCHAR(20) UNIQUE NOT NULL,
    cnh_categoria VARCHAR(5) NOT NULL,
    cnh_validade DATE NOT NULL,
    CHECK (cnh_categoria IN ('A', 'B', 'C', 'D', 'E', 'AB', 'AC', 'AD', 'AE'))
);

CREATE TABLE VEICULO (
    id_veiculo SERIAL PRIMARY KEY,
    placa VARCHAR(10) UNIQUE NOT NULL,
    tipo VARCHAR(50) NOT NULL,
    qtd_eixos INTEGER,
    capacidade_carga_kg NUMERIC(10, 2) NOT NULL,
    peso_veiculo_kg NUMERIC(10, 2) NOT NULL,
    dimensoes VARCHAR(50),
    autonomia_km_l NUMERIC(5, 2),
    km_abastecimento NUMERIC(10, 2)
);

CREATE TABLE ROTA (
    id_rota SERIAL PRIMARY KEY,
    id_veiculo INTEGER,
    ponto_partida VARCHAR(255) NOT NULL,
    ponto_destino VARCHAR(255) NOT NULL,
    duracao_prevista_min INTEGER,
    distancia_total_km NUMERIC(8, 2) NOT NULL
);

CREATE TABLE TRECHO_ROTA (
    id_trecho SERIAL,
    id_rota INTEGER NOT NULL,
    ordem_trecho INTEGER NOT NULL,
    ponto_intermediario VARCHAR(255) NOT NULL,
    distancia_km NUMERIC(8, 2) NOT NULL,
    PRIMARY KEY (id_trecho, id_rota)
);

CREATE TABLE MANUTENCAO (
    id_manutencao SERIAL PRIMARY KEY,
    id_veiculo INTEGER NOT NULL,
    tipo_manutencao VARCHAR(50) NOT NULL,
    data_realizacao DATE NOT NULL,
    km_manutencao NUMERIC(10, 2) NOT NULL,
    custo NUMERIC(10, 2),
    data_prox_manutencao DATE
);

CREATE TABLE ENTREGA (
    id_entrega SERIAL PRIMARY KEY,
    id_cliente INTEGER NOT NULL,
    id_motorista INTEGER,
    id_veiculo INTEGER,
    id_rota INTEGER,
    status VARCHAR(50) NOT NULL,
    valor_frete NUMERIC(10, 2),
    data_pagamento TIMESTAMP,
    CHECK (status IN ('PENDENTE', 'EM_TRANSITO', 'ENTREGUE', 'CANCELADA', 'ATRASADA', 'DEVOLVIDA'))
);

CREATE TABLE DETALHE_CARGA (
    id_entrega INTEGER PRIMARY KEY,
    descricao_carga VARCHAR(255) NOT NULL,
    tipo_carga VARCHAR(50) NOT NULL,
    peso_kg NUMERIC(8, 2) NOT NULL,
    altura_cm NUMERIC(6, 2),
    largura_cm NUMERIC(6, 2),
    profundidade_cm NUMERIC(6, 2),
    cep_coleta VARCHAR(10) NOT NULL,
    cep_entrega VARCHAR(10) NOT NULL,
    data_prevista_entrega DATE NOT NULL
);

CREATE TABLE INFO_ENTREGA_FINAL (
    id_entrega INTEGER PRIMARY KEY,
    data_hora_entrega TIMESTAMP NOT NULL,
    nome_recebedor VARCHAR(100) NOT NULL
);

ALTER TABLE MOTORISTA
ADD CONSTRAINT fk_motorista_funcionario
FOREIGN KEY (id_motorista) REFERENCES FUNCIONARIO (id_funcionario)
ON DELETE CASCADE;

ALTER TABLE ROTA
ADD CONSTRAINT fk_rota_veiculo
FOREIGN KEY (id_veiculo) REFERENCES VEICULO (id_veiculo);

ALTER TABLE TRECHO_ROTA
ADD CONSTRAINT fk_trecho_rota_rota
FOREIGN KEY (id_rota) REFERENCES ROTA (id_rota);

ALTER TABLE MANUTENCAO
ADD CONSTRAINT fk_manutencao_veiculo
FOREIGN KEY (id_veiculo) REFERENCES VEICULO (id_veiculo);

ALTER TABLE ENTREGA
ADD CONSTRAINT fk_entrega_cliente
FOREIGN KEY (id_cliente) REFERENCES CLIENTE (id_cliente);

ALTER TABLE ENTREGA
ADD CONSTRAINT fk_entrega_motorista
FOREIGN KEY (id_motorista) REFERENCES MOTORISTA (id_motorista);

ALTER TABLE ENTREGA
ADD CONSTRAINT fk_entrega_veiculo
FOREIGN KEY (id_veiculo) REFERENCES VEICULO (id_veiculo);

ALTER TABLE ENTREGA
ADD CONSTRAINT fk_entrega_rota
FOREIGN KEY (id_rota) REFERENCES ROTA (id_rota);

ALTER TABLE DETALHE_CARGA
ADD CONSTRAINT fk_detalhe_carga_entrega
FOREIGN KEY (id_entrega) REFERENCES ENTREGA (id_entrega)
ON DELETE CASCADE;

ALTER TABLE INFO_ENTREGA_FINAL
ADD CONSTRAINT fk_info_entrega_final_entrega
FOREIGN KEY (id_entrega) REFERENCES ENTREGA (id_entrega)
ON DELETE CASCADE;

INSERT INTO CLIENTE (nome, telefone, email, endereco_completo, cep) VALUES
('João Silva', '85998765432', 'joao.silva@exemplo.com', 'Rua A, 123 - Centro', '60000-001'),
('Maria Santos', '85991234567', 'maria.santos@exemplo.com', 'Av. B, 456 - Aldeota', '60100-002');

INSERT INTO FUNCIONARIO (id_funcionario, nome, telefone, email, data_nascimento, endereco_completo, cep, cargo) VALUES
(1, 'Pedro Souza', '85993456789', 'pedro.souza@logis.com', '1985-05-10', 'Rua C, 789', '60200-003', 'Motorista'),
(2, 'Ana Costa', '85997654321', 'ana.costa@logis.com', '1995-12-25', 'Av. D, 101', '60300-004', 'Motorista'),
(3, 'Carlos Lima', '85991112222', 'carlos.lima@logis.com', '1990-01-01', 'Rua E, 202', '60400-005', 'Administrativo');

INSERT INTO MOTORISTA (id_motorista, cnh_numero, cnh_categoria, cnh_validade) VALUES
(1, '12345678900', 'D', '2028-05-10'),
(2, '00987654321', 'A', '2034-12-25');

INSERT INTO VEICULO (id_veiculo, placa, tipo, qtd_eixos, capacidade_carga_kg, peso_veiculo_kg, dimensoes, autonomia_km_l, km_abastecimento) VALUES
(1, 'XYZ-1A23', 'Caminhão', 3, 15000.00, 8000.00, '9x2.5x3', 2.50, 95000.00),
(2, 'ABC-4B56', 'Moto', 2, 5.00, 150.00, '1x0.5x0.8', 35.00, 1500.00),
(3, 'DEF-7C89', 'Van', 2, 800.00, 2500.00, '4x1.8x2', 10.00, 50000.00);

INSERT INTO ROTA (id_rota, id_veiculo, ponto_partida, ponto_destino, duracao_prevista_min, distancia_total_km) VALUES
(1, 1, 'Depósito Fortaleza', 'Cliente João Silva - Centro', 120, 150.50),
(2, 2, 'Depósito Fortaleza', 'Cliente Maria Santos - Aldeota', 45, 12.80);

INSERT INTO TRECHO_ROTA (id_rota, ordem_trecho, ponto_intermediario, distancia_km) VALUES
(1, 1, 'Ponto de Apoio 1', 100.00),
(1, 2, 'Cliente João Silva - Centro', 50.50),
(2, 1, 'Cliente Maria Santos - Aldeota', 12.80);

INSERT INTO MANUTENCAO (id_manutencao, id_veiculo, tipo_manutencao, data_realizacao, km_manutencao, custo, data_prox_manutencao) VALUES
(1, 1, 'Revisão 100K', '2025-10-01', 90000.00, 2500.00, '2026-04-01');

INSERT INTO ENTREGA (id_entrega, id_cliente, id_motorista, id_veiculo, id_rota, status, valor_frete, data_pagamento) VALUES
(1, 1, 1, 1, 1, 'ENTREGUE', 350.00, '2025-11-20 10:00:00'),
(2, 2, 2, 2, 2, 'EM_TRANSITO', 25.00, '2025-11-27 15:00:00'),
(3, 1, NULL, NULL, NULL, 'PENDENTE', 150.00, NULL);

INSERT INTO DETALHE_CARGA (id_entrega, descricao_carga, tipo_carga, peso_kg, altura_cm, largura_cm, profundidade_cm, cep_coleta, cep_entrega, data_prevista_entrega) VALUES
(1, '10 caixas de eletrônicos', 'Carga Seca', 500.00, 100.00, 100.00, 100.00, '60500-001', '60000-001', '2025-11-22'),
(2, 'Documentos Urgentes', 'Carga Seca', 1.00, 20.00, 30.00, 1.00, '60150-000', '60100-002', '2025-11-27');

INSERT INTO INFO_ENTREGA_FINAL (id_entrega, data_hora_entrega, nome_recebedor) VALUES
(1, '2025-11-20 12:30:00', 'Fernando Pires');

--Relatório de Entregas por Cliente
SELECT 
    c.id_cliente,
    c.nome AS nome_cliente,
    e.id_entrega,
    e.status,
    dc.data_prevista_entrega
FROM CLIENTE c
LEFT JOIN ENTREGA e ON e.id_cliente = c.id_cliente
LEFT JOIN DETALHE_CARGA dc ON dc.id_entrega = e.id_entrega
ORDER BY c.id_cliente, e.id_entrega;

--Relatório de Utilização de Veículos
SELECT 
    v.id_veiculo,
    v.placa,
    v.tipo,
    
    -- Quantidade de entregas registradas para o veículo
    COUNT(e.id_entrega) AS total_entregas,

    -- Status do veículo
    CASE 
        WHEN EXISTS (
            SELECT 1 FROM MANUTENCAO m 
            WHERE m.id_veiculo = v.id_veiculo
              AND m.data_prox_manutencao > CURRENT_DATE
        ) THEN 'MANUTENÇÃO'
        
        WHEN EXISTS (
            SELECT 1 FROM ENTREGA e2
            WHERE e2.id_veiculo = v.id_veiculo
              AND e2.status = 'EM_TRANSITO'
        ) THEN 'EM USO'

        ELSE 'DISPONÍVEL'
    END AS status_veiculo

FROM VEICULO v
LEFT JOIN ENTREGA e ON e.id_veiculo = v.id_veiculo
GROUP BY v.id_veiculo, v.placa, v.tipo
ORDER BY v.id_veiculo;

--Relatório de Status de Entregas por Mês
SELECT 
    TO_CHAR(e.data_pagamento, 'YYYY-MM') AS ano_mes,
    e.status,
    COUNT(*) AS total
FROM ENTREGA e
WHERE e.data_pagamento IS NOT NULL
GROUP BY TO_CHAR(e.data_pagamento, 'YYYY-MM'), e.status
ORDER BY ano_mes, status;

--Relatório de Desempenho dos Motoristas
SELECT 
    m.id_motorista,
    f.nome AS nome_motorista,

    -- Entregas concluídas
    COUNT(CASE WHEN e.status = 'ENTREGUE' THEN 1 END) AS entregas_concluidas,

    -- Canceladas
    COUNT(CASE WHEN e.status = 'CANCELADA' THEN 1 END) AS entregas_canceladas,

    -- Total geral
    COUNT(e.id_entrega) AS total_entregas
FROM MOTORISTA m
JOIN FUNCIONARIO f ON f.id_funcionario = m.id_motorista
LEFT JOIN ENTREGA e ON e.id_motorista = m.id_motorista
GROUP BY m.id_motorista, f.nome
ORDER BY m.id_motorista;


